#!/usr/bin/env python3
import subprocess, time

def run(command: str) -> str:
    proc = subprocess.run(
        command.split(), 
        capture_output=True, text=True, check=True
    )

    return proc.stdout

try:
    out = run("bluetoothctl show")
    is_bluetooth_active = "Powered: yes" in out
    
except subprocess.CalledProcessError:
    is_bluetooth_active = False

if is_bluetooth_active:
    out = run("bluetoothctl devices Connected").strip()

    # Check if there is a connection to a device
    if out.splitlines()[0].startswith("Device"):
        run("playerctl pause")
    
    run("bluetoothctl power off")
    run("rfkill block bluetooth")

else:
    run("rfkill unblock bluetooth")
    time.sleep(1)
    run("bluetoothctl power on")
    
    out = run("bluetoothctl devices Paired")
    last_device = ""

    for line in out.splitlines():
        if not line.startswith("Device"):
            continue
            
        last_device = line

    device_mac = last_device.split()[1]
    subprocess.run(['bluetoothctl', 'connect', device_mac])
